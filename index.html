<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ChatGPT-like Interface</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Global dark theme */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: #343541;
      color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    /* Header */
    header {
      background: #202123;
      padding: 1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { margin: 0; font-size: 1.2em; }
    header button {
      background: #10a37f;
      border: none;
      color: white;
      padding: 0.5em 1em;
      border-radius: 5px;
      cursor: pointer;
    }
    header button:hover { background: #0d8b68; }
    /* Chat container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 1em;
      display: flex;
      flex-direction: column;
      gap: 1em;
    }
    /* Message bubbles */
    .message {
      max-width: 70%;
      padding: 1em;
      border-radius: 8px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .user {
      align-self: flex-end;
      background: #10a37f;
      color: white;
    }
    .assistant {
      align-self: flex-start;
      background: #444654;
    }
    /* Input area */
    .input-area {
      background: #40414f;
      padding: 1em;
      display: flex;
    }
    .input-area input {
      flex: 1;
      padding: 0.5em;
      border: none;
      border-radius: 5px;
      background: #202123;
      color: white;
    }
    .input-area button {
      margin-left: 0.5em;
      background: #10a37f;
      border: none;
      color: white;
      padding: 0.5em 1em;
      border-radius: 5px;
      cursor: pointer;
    }
    .input-area button:hover {
      background: #0d8b68;
    }
    /* Typing indicator */
    .typing-indicator {
      display: inline-block;
      margin-left: 5px;
    }
    .typing-indicator span {
      display: inline-block;
      width: 6px;
      height: 6px;
      margin: 0 2px;
      background: white;
      border-radius: 50%;
      opacity: 0;
      animation: typing 1s infinite;
    }
    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0% { opacity: 0.2; }
      20% { opacity: 1; }
      100% { opacity: 0.2; }
    }
    /* Code block style */
    .code-block {
      background-color: #202123;
      border: 1px solid #444;
      border-radius: 5px;
      padding: 1em;
      margin-top: 0.5em;
      position: relative;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    .copy-button {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: #10a37f;
      border: none;
      color: white;
      padding: 0.2em 0.5em;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .copy-button:hover {
      background-color: #0d8b68;
    }
  </style>
</head>
<body>
  <header>
    <h1>ChatGPT-like Interface</h1>
    <button onclick="newChat()">New Chat</button>
  </header>

  <div class="chat-container" id="chat-container">
    <!-- Chat messages will appear here -->
  </div>

  <div class="input-area">
    <input type="text" id="user-input" placeholder="Type your message...">
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    // API endpoint – modify as needed
    const API_URL = "https://dev-pycodz-blackbox.pantheonsite.io/DEvZ44d/deepseek.php?text=";
    // Array to hold chat messages; each message is an object:
    // { id, role ('user' or 'assistant'), content, typed (for typing indicator), codeBlocks (array) }
    let messages = [];

    // Send the user's message
    function sendMessage() {
      const inputField = document.getElementById('user-input');
      const text = inputField.value.trim();
      if (!text) return;
      inputField.value = "";
      
      // Add user's message
      addMessage("user", text);
      
      // Add an assistant "typing" placeholder
      const tempId = addMessage("assistant", "", true);
      
      // Call the API
      fetch(API_URL + encodeURIComponent(text))
        .then(res => res.text())
        .then(data => {
          // Remove the typing placeholder
          removeMessage(tempId);
          
          // Parse the API response, extracting code blocks if any
          const { textOnly, codeBlocks } = parseAiResponse(data);
          // Add the assistant's final message with typing animation
          addMessage("assistant", textOnly, false, codeBlocks);
        })
        .catch(err => {
          removeMessage(tempId);
          addMessage("assistant", "Error connecting to AI.", false);
          console.error(err);
        });
    }

    // Clear the chat for a new conversation
    function newChat() {
      messages = [];
      renderMessages();
    }

    // Add a message to the messages array and render
    // "typed" indicates a placeholder (e.g. typing indicator)
    // "codeBlocks" is an array of code strings extracted from the response
    function addMessage(role, content, typed=false, codeBlocks=[]) {
      const id = Date.now() + Math.random();
      messages.push({ id, role, content, typed, codeBlocks });
      renderMessages();
      return id;
    }

    // Remove a message by its id (used for removing typing placeholders)
    function removeMessage(id) {
      messages = messages.filter(m => m.id !== id);
      renderMessages();
    }

    // Render all messages to the chat container
    function renderMessages() {
      const container = document.getElementById("chat-container");
      container.innerHTML = "";
      
      messages.forEach(msg => {
        const bubble = document.createElement("div");
        bubble.classList.add("message", msg.role);
        
        if (msg.typed) {
          bubble.innerHTML = `Typing <span class="typing-indicator"><span></span><span></span><span></span></span>`;
          container.appendChild(bubble);
        } else {
          if (msg.role === "assistant") {
            // For assistant messages, type out the text
            bubble.textContent = "";
            container.appendChild(bubble);
            typeText(bubble, msg.content, 0, () => {
              // After text animation, if there are code blocks, render each
              if (msg.codeBlocks && msg.codeBlocks.length > 0) {
                msg.codeBlocks.forEach(code => {
                  const codeElem = renderCodeBlock(code);
                  bubble.appendChild(codeElem);
                });
              }
            });
          } else {
            // For user messages, display immediately
            bubble.textContent = msg.content;
            container.appendChild(bubble);
          }
        }
      });
      // Scroll to the bottom of the chat container
      container.scrollTop = container.scrollHeight;
    }

    // Animate typing of text into an element
    function typeText(element, text, index, callback) {
      if (index < text.length) {
        element.textContent += text.charAt(index);
        setTimeout(() => typeText(element, text, index + 1, callback), 20);
      } else {
        if (callback) callback();
      }
    }

    // Create and return a code block element with a "Copy" button
    function renderCodeBlock(code) {
      const container = document.createElement("div");
      container.classList.add("code-block");
      
      const pre = document.createElement("pre");
      pre.textContent = code;
      container.appendChild(pre);
      
      const copyBtn = document.createElement("button");
      copyBtn.classList.add("copy-button");
      copyBtn.textContent = "Copy";
      copyBtn.onclick = function() {
        copyToClipboard(code);
      };
      container.appendChild(copyBtn);
      
      return container;
    }

    // Copy provided text to clipboard
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert("Code copied!");
      }, () => {
        alert("Failed to copy code.");
      });
    }

    // Parse the API response, extract code blocks (delimited by triple backticks),
    // and remove unwanted text (like "channel:" or "last update:").
    function parseAiResponse(data) {
      let text = data;
      let codeBlocks = [];
      
      // Try to parse as JSON first (if applicable)
      try {
        const parsed = JSON.parse(data);
        if (parsed.response) {
          text = parsed.response;
        }
      } catch(e) {
        // Not JSON – treat as plain text
      }
      
      // Remove unwanted labels
      text = text.replace(/channel:.*/gi, "").replace(/last update:.*/gi, "").trim();
      
      // Extract code blocks marked by triple backticks
      const codeRegex = /```([\s\S]*?)```/g;
      let match;
      while ((match = codeRegex.exec(text)) !== null) {
        codeBlocks.push(match[1].trim());
      }
      // Remove the code blocks from the text so that only the non-code part remains
      text = text.replace(codeRegex, "").trim();
      
      return { textOnly: text, codeBlocks };
    }
  </script>
</body>
</html>